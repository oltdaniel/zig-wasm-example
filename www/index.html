<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <input type="text" id="name" value="Daniel" required />
    <button id="btn-greet">Greet</button>

    <script type="module">
      import ZigWASMWrapper from "./helper.js";

      let wasm = await ZigWASMWrapper.initialize("./main.wasm");

      // === Interface Test ===
      wasm.silence();

      console.log(wasm.testVoid());
      wasm.printVoid(null);

      console.log(wasm.testBool());
      wasm.printBool(true);

      console.log(wasm.testInt());
      wasm.printInt(-12345);

      console.log(wasm.testUint());
      wasm.printUint(12345);

      console.log(wasm.testFloat());
      wasm.printFloat(1.2345);

      console.log(wasm.testBytes());
      wasm.printBytes(new TextEncoder().encode("Hello World"));

      console.log(wasm.testString());
      wasm.printString("Bye World");

      console.log(wasm.testJSON());
      wasm.printJSON({ message: "Greetings" });

      const testFunctionRef = wasm.testFunctionRef();
      console.log(wasm.testFunction(testFunctionRef));

      console.log(wasm.greet("Daniel"));

      // === Example Application ===
      function measure(label, func) {
        const t0 = performance.now();

        func();

        const t1 = performance.now();
        console.log(`${label} took ${t1 - t0}ms.`);
      }

      document.getElementById("btn-greet").addEventListener("click", () => {
        measure("greet and hash", () => {
          const name = document.getElementById("name").value;

          console.log(wasm.greet(name));

          console.log(wasm.blake2b(`this is a hashing input for ${name}`));
        });
      });

      measure("initial greet and hash", () => {
        console.log(wasm.greet("Daniel"));

        console.log(
          wasm.blake2b("This is just some hashing input to think about")
        );
      });

      // === Hash Benchmark ===
      const ROUNDS = 1000;

      const t0 = performance.now();

      for (let i = 0; i < ROUNDS; i++) {
        // NOTE: There is an obvious performance penalty here, in JS and Zig,
        //       compared to raw native performance.
        wasm.blake2b("Some hash");
      }

      const t1 = performance.now();
      console.log(
        `Benchmark (hash with ${ROUNDS}rounds): total=${t1 - t0}ms; per round=${
          (t1 - t0) / ROUNDS
        }`
      );
    </script>
  </body>
</html>
